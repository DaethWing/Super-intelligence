<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>My AI Chat</title>
    <style>
      :root { color-scheme: dark; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0c10; color:#e6e6e6; }
      .wrap { max-width: 840px; margin: 0 auto; padding: 24px; }
      h1 { font-size: 22px; margin: 0 0 10px; }
      .card { background:#14161d; border:1px solid #232635; border-radius:14px; padding:16px; }
      .msgs { height: 60vh; overflow:auto; padding-right:4px; }
      .msg { padding:10px 12px; border-radius:12px; margin:8px 0; white-space:pre-wrap; word-break:break-word; line-height:1.45; }
      .user { background:#1c2233; }
      .ai { background:#171e2b; }
      form { display:flex; gap:8px; margin-top:12px; }
      input { flex:1; padding:12px; border-radius:12px; border:1px solid #2a2f3e; background:#0f1320; color:#e6e6e6; }
      button { padding:12px 14px; border-radius:12px; border:0; background:#2b3352; color:#fff; cursor:pointer; }
      button:disabled { opacity:.6; cursor:not-allowed; }
      .status { font-size:12px; opacity:.75; margin-top:6px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>My AI Chat</h1>
      <div class="card">
        <div id="msgs" class="msgs"></div>
        <form id="chatForm">
          <input id="q" placeholder="Ask anything (safe & legal)..." autocomplete="off"/>
          <button id="send">Send</button>
        </form>
        <div id="status" class="status"></div>
      </div>
    </div>
    <script>
      const msgsEl = document.getElementById('msgs');
      const statusEl = document.getElementById('status');
      const inputEl = document.getElementById('q');
      const sendBtn = document.getElementById('send');
      const history = [];
      const addMsg = (role, text) => {
        const div = document.createElement('div');
        div.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
        div.textContent = text;
        msgsEl.appendChild(div);
        msgsEl.scrollTop = msgsEl.scrollHeight;
        return div;
      };
      document.getElementById('chatForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = inputEl.value.trim();
        if (!text) return;
        inputEl.value = '';
        addMsg('user', text);
        history.push({ role: 'user', content: text });
        sendBtn.disabled = true;
        statusEl.textContent = 'Thinkingâ€¦';
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: history })
        });
        if (!resp.ok || !resp.body) {
          const err = await resp.text();
          addMsg('assistant', 'Error: ' + err);
          statusEl.textContent = '';
          sendBtn.disabled = false;
          return;
        }
        const aiDiv = addMsg('assistant', '');
        const reader = resp.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buffer = '';
        let full = '';
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const chunks = buffer.split('\n\n');
          buffer = chunks.pop();
          for (const chunk of chunks) {
            if (!chunk.startsWith('data:')) continue;
            const data = chunk.slice(5).trim();
            if (data === '[DONE]') continue;
            try {
              const json = JSON.parse(data);
              const delta = json.choices?.[0]?.delta?.content || '';
              if (delta) {
                full += delta;
                aiDiv.textContent = full;
                msgsEl.scrollTop = msgsEl.scrollHeight;
              }
            } catch {}
          }
        }
        statusEl.textContent = '';
        sendBtn.disabled = false;
        history.push({ role: 'assistant', content: full });
      });
    </script>
  </body>
</html>
